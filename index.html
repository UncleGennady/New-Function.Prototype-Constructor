<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <script src="./script.js"></script>
    <script src="./class.js"></script>
</body>
</html>

<script>
    import { loadTicker } from "./api";
    
    export default {
      name: "App",
    
      data() {
        return {
          ticker: null,
          tickers: [],
          sel: null,
          graph: [],
          filter: "",
          page: 1,
        };
      },
    
      created() {
        const localData = localStorage.getItem("tickers-list");
        const sessionFilter = sessionStorage.getItem("page-coins");
        if (localData) {
          this.tickers = JSON.parse(localData);
        }
    
        setInterval(this.updateTickers, 7000);
    
        if (sessionFilter) {
          this.page = JSON.parse(sessionFilter).pageIndex;
          this.filter = JSON.parse(sessionFilter).filterValue;
        }
      },
    
      computed: {
        startIndex() {
          return (this.page - 1) * 6;
        },
        endIndex() {
          return this.page * 6;
        },
        filteredTickers() {
          return this.tickers.filter((ticker) => {
            return ticker.name.includes(this.filter);
          });
        },
        hasNextPage() {
          return this.filteredTickers.length > this.endIndex;
        },
    
        normalizedGraph() {
          const maxValue = Math.max(...this.graph);
          const minValue = Math.min(...this.graph);
          if (maxValue === minValue) {
            return this.graph.map(() => 50);
          }
          return this.graph.map(
            (price) => 10 + ((price - minValue) * 90) / (maxValue - minValue)
          );
        },
      },
    
      methods: {
        setLocalKey(item, key) {
          return localStorage.setItem(key, JSON.stringify(item));
        },
        setSessionKey(item, key) {
          return sessionStorage.setItem(key, JSON.stringify(item));
        },
        paginatedTickers() {
          if (this.endIndex - this.filteredTickers.length === 6) {
            this.page = this.page - 1;
          }
          const dataFilter = { pageIndex: this.page, filterValue: this.filter };
          this.setSessionKey(dataFilter, "page-coins");
          return this.filteredTickers.slice(this.startIndex, this.endIndex);
        },
        async updateTickers() {
          if (!this.tickers.length) {
            return;
          }
    
          const exchangeData = await loadTicker(this.tickers.map((t) => t.name));
    
          this.tickers.forEach((ticker) => {
            const price = exchangeData[ticker.name.toUpperCase()];
            if (!price) {
              ticker.price = "-";
              return;
            }
            const normalizedPrise = 1 / price;
            const formattedPrice =
              normalizedPrise > 1
                ? normalizedPrise.toFixed(2)
                : normalizedPrise.toPrecision(2);
            ticker.price = formattedPrice;
          });
        },
        add() {
          if (!this.ticker || !this.ticker.trim()) {
            return;
          }
          if (this.validateCoin(this.ticker)) {
            return;
          }
          const el = {
            name: this.ticker.trim(),
            price: null,
          };
          this.tickers.push(el);
          this.setLocalKey(this.tickers, "tickers-list");
          this.ticker = "";
          this.filter = "";
        },
        handlerDelete(tickersToDelete) {
          this.tickers = this.tickers.filter((t) => t !== tickersToDelete);
          if (this.tickers.length) {
            this.setLocalKey(this.tickers, "tickers-list");
          } else {
            localStorage.removeItem("tickers-list");
          }
          if (this.sel === tickersToDelete) {
            this.sel = null;
          }
        },
        handlerSel(t) {
          this.sel = t;
          this.graph = [];
        },
        validateCoin(t) {
          if (typeof t === "string") {
            t = t.trim();
          }
          for (const argument of this.tickers) {
            if (argument.name === t) return true;
          }
          return false;
        },
      },
      watch: {
        filter() {
          this.page = 1;
        },
      },
    };
    </script>